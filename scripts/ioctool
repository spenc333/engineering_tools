#!/bin/bash

function iocfpv {
   ioc=""
   ioc=$(grep_pv $1 | cut -d'/' -f5 | sed -r '/^('$1').*/d' | sed -r '/^IOC.*/d')
   if [ -z "$ioc" ]; then
      echo "Did not find an ioc associated with this PV." >&2 
      exit 1
   elif [[ $ioc = *[[:space:]]* ]]; then #assuming multiple iocs are separeated by a space
      declare -a ioc_array     
      for entry in $ioc; do
         ioc_array+=($entry)
      done 
      echo "$1 is found in ${#ioc_array[@]} places"
      if [[ ${#ioc_array[@]} -gt 1 ]]; then
         echo "Which ioc do care about here?"
         printf '%s\n' "${ioc_array[@]}" 
         read chosenioc
         if [[ -z "$chosenioc" ]]; then
             ioc="nothing"
             echo "Please pick an ioc."
             exit 0
         fi   
         ioc=$chosenioc      
      echo "You have chosen" $ioc
       
      fi
   fi
   
}

function iocdir {
   ioc=$1
   iocpath=""
   iocpath=$(grep_ioc "$ioc" all | grep "id:'$ioc'" | sed -n "s/^.*dir: '\(\S*\)'.*$/\1/p");
   if [[ -z $iocpath ]]; then
      echo "Did not find ${ioc} running anywhere. Exiting..." >&2
      exit 1
   fi
   
   if [[ ! $iocpath =~ ^/.* ]]; then
      iocpath=/reg/g/pcds/epics/"${iocpath}"  
   fi

}

function ioccfg {
   iocdir "$1"
   iocfile=$(find ${iocpath} -name "$1.cfg")
   if [ -z  "$iocfile" ]; then
      iocfile=$(find ${iocpath} -name "st.cmd")
      if [ -z "$iocfile" ]; then
         echo -e "No files found for that ioc" >&2

         exit 1
      fi
   fi

}

usage(){
cat << EOF
usage: $0 <ioc>|<pv> [option]

Script that returns information about an ioc given its name or a PV it hosts

default option is 'name', list of options:
name   : returns the name of the ioc
dir    : returns the directory the ioc is running from
cddir  : open the directory the ioc is running from (start with "source" before calling script with this option)
cfg    : returns the file name of the ioc .cfg (or st.cmd)i
less   : opens the ioc .cfg (or st.cmd) in less
cat    : opens the ioc .cfg (or st.cmd) in cat
data   : returns the path of the appropriate iocData directory if it exists
autosave : opens the ioc most recent autosave file in less
archive  : opens the ioc most recent archive file in less
log    : opens the most recent log file in less
telnet : starts a telnet session with the ioc 

EOF
}

if [ $# -lt 1 ]; then
   echo 'need arguments: input ioc or pv name' >&2
   usage
   exit 1
fi 

if [[ ($1 == "--help") || ($1 == "-h") ]]; then
   usage
   exit 0
fi
	
NAME=$1
CMD=$2

#################################################################

if [[ $NAME == *':'* ]]; then #we are assuming that PVs have a colon in them
   iocfpv "$NAME"
   NAME="$ioc"
   
elif [[ ! $NAME == *'-'* ]]; then #We are assuming that ioc names contain an a dash in them
   echo "${NAME} does not match the format for PVs or IOC names. Exiting..."
   exit 1  

else
   INFO=$(grep_ioc "$NAME" all | grep "id:'$NAME'")
      if [ -z "$INFO" ]; then
         NAME=$(echo $INFO | sed -n "s/^.*id: '\(\S*\)'.*$/\1/p")
      fi   
fi
    

#################################################################

if [ "$CMD" == "name" ] || [ "$CMD" == "" ]; then
   echo "$NAME"

#################################################################

elif [ "$CMD" ==  "dir" ]; then
   iocdir "$NAME"
   echo "$iocpath"

#################################################################

elif [ "$CMD" == "cddir" ]; then
   iocdir "$NAME"
   [[ "${BASH_SOURCE[0]}" == "$0" ]] && echo "Script is not being sourced. Start with 'source $0' before calling script with this option." || cd "${iocpath}" 
 
#################################################################

elif [ "$CMD" == "cfg" ]; then
   ioccfg "$NAME"
   echo "$iocfile"

#################################################################

elif [ "$CMD" == "less" ]; then
   ioccfg "$NAME"
   less "$iocfile"

#################################################################

elif [ "$CMD" == "cat" ]; then
   ioccfg "$NAME"
   cat "$iocfile"

#################################################################

elif [ "$CMD" == "data" ]; then
   iocdatapath=/reg/d/iocData/"${NAME}"/iocInfo
   if [ -d "$iocdatapath" ]; then
      echo "${iocdatapath}"
   else
      echo "$iocdatapath could not be found. Exiting..."
   fi

#################################################################

elif [ "$CMD" == "autosave" ]; then
   autosavefile=/reg/d/iocData/"${NAME}"/autosave/${NAME}.sav
   if [ -f "$autosavefile" ]; then
      less "$autosavefile"
   else
      echo "Recent autosave file could not be found."
   fi

#################################################################

elif [ "$CMD" == "archive" ]; then
   archivefile=/reg/d/iocData/"${NAME}"/archive/${NAME}.archive
   if [ -f "$archivefile" ]; then
      less "$archivefile"
   else
      echo "Archive file could not be found."
   fi

#################################################################

elif [ "$CMD" == "log" ]; then
   logfile=/reg/d/iocData/"${NAME}"/iocInfo/ioc.log
   if [ -f "$logfile" ]; then
      less "$logfile"
   else
      echo "Recent log file could not be found."
   fi

#################################################################

elif [ "$CMD" == "telnet" ]; then
   INFO=$(grep_ioc "$NAME" all | grep "id:'$NAME'")
   if [ -z "$INFO" ]; then
      echo "$NAME could not be found. Exiting..." >&2
      exit 1
   fi
   
   HOST=$(echo "$INFO" | sed -n "s/^.*host: '\(\S*\)'.*$/\1/p")
   PORT=$(echo "$INFO" | sed -n "s/^.*port: \(\S*\),.*$/\1/p")
   #if [[ 39000 >= "$PORT" >=39999 ]];
    #  echo "Host no in subnet that connect"
   echo "$HOST":"$PORT"
   telnet "$HOST" "$PORT"
fi
